{"version":3,"file":"register.js","sources":["pages/register/register.vue","pages/register/register.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <view class=\"header\">\n      <view class=\"back-button\" @tap=\"goBack\">\n        <text class=\"back-arrow\">←</text>\n      </view>\n      <text class=\"title\">注册账号</text>\n    </view>\n\n    <view class=\"avatar-section\">\n      <button class=\"avatar-wrapper\" open-type=\"chooseAvatar\" @chooseavatar=\"onChooseAvatar\">\n        <image class=\"avatar\" :src=\"userInfo.avatarUrl || defaultAvatarUrl\" mode=\"aspectFill\" />\n        <text class=\"tip\">点击更换头像</text>\n      </button>\n      <view class=\"nickname-wrapper\">\n        <text class=\"nickname-label\">昵称</text>\n        <input \n          type=\"nickname\" \n          class=\"nickname-input\" \n          placeholder=\"请输入昵称\" \n          @change=\"onNicknameChange\"\n          v-model=\"userInfo.nickName\"\n        />\n      </view>\n    </view>\n\n    <view class=\"form-section\">\n      <view class=\"input-group\">\n        <text class=\"label\">昵称</text>\n        <input \n          type=\"nickname\" \n          class=\"input-field\" \n          placeholder=\"请输入昵称\" \n          @change=\"onNicknameChange\"\n          v-model=\"userInfo.nickName\"\n        />\n      </view>\n\n      <view class=\"input-group\">\n        <text class=\"label\">手机号</text>\n        <input \n          class=\"input-field\" \n          type=\"number\" \n          v-model=\"phone\" \n          placeholder=\"请输入手机号\"\n          maxlength=\"11\"\n        />\n      </view>\n\n      <view class=\"input-group\">\n        <text class=\"label\">密码</text>\n        <input \n          class=\"input-field\" \n          type=\"password\" \n          v-model=\"password\" \n          placeholder=\"请设置密码\"\n          maxlength=\"20\"\n        />\n      </view>\n\n      <view class=\"input-group\">\n        <text class=\"label\">选择AI角色</text>\n        <view class=\"radio-group\">\n          <view \n            v-for=\"(role, index) in aiRoles\" \n            :key=\"index\"\n            class=\"radio-item\"\n            :class=\"{ 'radio-item-active': aiCharacterName === role.value }\"\n            @tap=\"selectRole(role.value)\"\n          >\n            <text>{{ role.label }}</text>\n          </view>\n        </view>\n      </view>\n\n      <view class=\"input-group\">\n        <text class=\"label\">内测码（选填）</text>\n        <input \n          class=\"input-field\" \n          type=\"text\" \n          v-model=\"betaCode\" \n          placeholder=\"如有内测码请输入\"\n        />\n      </view>\n    </view>\n\n    <button class=\"submit-button\" @tap=\"handleRegister\">注册</button>\n  </view>\n</template>\n\n<script>\nimport { request } from '@/utils/api.js'\n\nconst defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'\n\nexport default {\n  data() {\n    return {\n      defaultAvatarUrl,\n      userInfo: {\n        avatarUrl: '',\n        nickName: '',\n        openId: ''  // 添加 openId 字段\n      },\n      phone: '',\n      password: '',\n      betaCode: '',\n      aiCharacterName: 'default',  // 添加默认 AI 角色\n      aiRoles: [\n        { label: '温柔姐姐', value: 'gentle' },\n        { label: '严厉哥哥', value: 'strict' },\n        { label: '毒舌', value: 'sharp_tongue' }\n      ]\n    }\n  },\n  methods: {\n    goBack() {\n      uni.navigateBack()\n    },\n    getUserProfile() {\n      // 使用微信小程序原生的用户信息接口\n      wx.getUserProfile({\n        desc: '用于完善用户资料',\n        success: (res) => {\n          this.userInfo = {\n            avatarUrl: res.userInfo.avatarUrl,\n            nickName: res.userInfo.nickName\n          }\n          \n          uni.showToast({\n            title: '授权成功',\n            icon: 'success'\n          })\n        },\n        fail: (err) => {\n          console.error('获取用户信息失败：', err)\n          uni.showToast({\n            title: '获取信息失败',\n            icon: 'none'\n          })\n        }\n      })\n    },\n\n    onNicknameChange(e) {\n      this.userInfo.nickName = e.detail.value\n    },\n\n    // 添加选择角色的方法\n    selectRole(value) {\n      this.aiCharacterName = value\n    },\n\n    async handleRegister() {\n      if (!this.userInfo.avatarUrl) {\n        uni.showToast({\n          title: '请先选择头像',\n          icon: 'none'\n        })\n        return\n      }\n      \n      if (!this.userInfo.nickName) {\n        uni.showToast({\n          title: '请输入昵称',\n          icon: 'none'\n        })\n        return\n      }\n      \n      if (!this.phone || !/^1\\d{10}$/.test(this.phone)) {\n        uni.showToast({\n          title: '请输入正确的手机号',\n          icon: 'none'\n        })\n        return\n      }\n      \n      if (!this.password || this.password.length < 6) {\n        uni.showToast({\n          title: '密码不能少于6位',\n          icon: 'none'\n        })\n        return\n      }\n\n      uni.showLoading({\n        title: '注册中...'\n      })\n      \n      try {\n        const registerData = {\n          avatarUrl: this.userInfo.avatarUrl,\n          nickName: this.userInfo.nickName,\n          telephone: this.phone,\n          password: this.password,\n          wechat_openid: this.userInfo.openId || undefined,\n          registration_code: this.betaCode || undefined,\n          ai_character_name: this.aiCharacterName  // 确保这个值被包含在注册数据中\n        }\n        \n        // 移除所有 undefined 的字段\n        Object.keys(registerData).forEach(key => {\n          if (registerData[key] === undefined) {\n            delete registerData[key]\n          }\n        })\n        \n        const res = await request({\n          url: '/habit-ai/user/register',\n          method: 'POST',\n          data: registerData\n        })\n        \n        // 存储用户信息时也保存 openId\n        uni.setStorageSync('token', res.token)\n        uni.setStorageSync('userInfo', {\n          avatarUrl: this.userInfo.avatarUrl,\n          nickName: this.userInfo.nickName,\n          phone: this.phone,\n          userId: res.user_id,\n          openId: this.userInfo.openId\n        })\n        \n        uni.showToast({\n          title: '注册成功',\n          icon: 'success'\n        })\n        \n        setTimeout(() => {\n          uni.reLaunch({\n            url: '/pages/index/index'\n          })\n        }, 1500)\n      } catch (error) {\n        uni.showToast({\n          title: error.message || '注册失败',\n          icon: 'none'\n        })\n      } finally {\n        uni.hideLoading()\n      }\n    },\n    async onChooseAvatar(e) {\n      const { avatarUrl } = e.detail \n      this.userInfo.avatarUrl = avatarUrl\n      \n      try {\n        // TODO 获取微信 openid\n        // 使用 wx.login 获取登录凭证\n        // const { code } = await new Promise((resolve, reject) => {\n        //   wx.login({\n        //     success: resolve,\n        //     fail: reject\n        //   })\n        // })\n        // // 通过登录凭证获取 openid\n        // const openIdResult = await request({\n        //   url: '/habit-ai/user/wx-openid',\n        //   method: 'POST',\n        //   data: { code }\n        // })\n        // this.userInfo.openId = openIdResult.openid\n        \n        uni.showToast({\n          title: '头像设置成功',\n          icon: 'success'\n        })\n      } catch (error) {\n        console.error('获取 openid 失败：', error)\n        // 即使获取 openid 失败，也不影响头像设置\n        uni.showToast({\n          title: '头像设置成功',\n          icon: 'success'\n        })\n      }\n    },\n\n    getUserProfile() {\n      uni.getUserProfile({\n        desc: '用于完善会员资料',\n        success: (res) => {\n          this.userInfo.nickName = res.userInfo.nickName\n          uni.showToast({\n            title: '昵称设置成功',\n            icon: 'success'\n          })\n        },\n        fail: (err) => {\n          console.error('获取用户信息失败：', err)\n          uni.showToast({\n            title: '获取信息失败',\n            icon: 'none'\n          })\n        }\n      })\n    }\n  }\n}\n</script>\n\n<style>\n.container {\n  padding: 40rpx;\n  min-height: 100vh;\n  background-color: #fff;\n}\n\n.header {\n  display: flex;\n  align-items: center;\n  margin-bottom: 60rpx;\n  position: relative;\n}\n\n.back-button {\n  position: absolute;\n  left: 0;\n  width: 80rpx;\n  height: 80rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.back-arrow {\n  font-size: 40rpx;\n  color: #2c3e50;\n}\n\n.title {\n  width: 100%;\n  text-align: center;\n  font-size: 36rpx;\n  font-weight: 600;\n  color: #2c3e50;\n}\n\n.avatar-section {\n  display: flex;\n  justify-content: center;\n  margin-bottom: 60rpx;\n}\n\n.avatar-wrapper {\n  background: none;\n  border: none;\n  padding: 0;\n  margin: 0;\n  width: 200rpx;  /* 减小头像容器大小 */\n  height: 200rpx;\n}\n\n.avatar-wrapper:after {\n  border: none;\n}\n\n.avatar {\n  width: 200rpx;  /* 减小头像大小 */\n  height: 200rpx;\n  border-radius: 50%;  /* 保持圆形 */\n}\n\n/* 移除不需要的样式 */\n.nickname-wrapper,\n.nickname-label,\n.nickname-input,\n.tip {\n  display: none;\n}\n\n.nickname-wrapper {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 10rpx;\n  margin-top: 20rpx;\n}\n\n.nickname-label {\n  font-size: 28rpx;\n  color: #5c6b7a;\n}\n\n.nickname-input {\n  width: 300rpx;\n  height: 80rpx;\n  background: #f5f7fa;\n  border-radius: 10rpx;\n  padding: 0 20rpx;\n  font-size: 32rpx;\n  color: #2c3e50;\n  text-align: center;\n}\n\n.form-section {\n  display: flex;\n  flex-direction: column;\n  gap: 40rpx;\n  margin-bottom: 60rpx;\n}\n\n.input-group {\n  display: flex;\n  flex-direction: column;\n  gap: 20rpx;\n}\n\n.label {\n  font-size: 28rpx;\n  color: #5c6b7a;\n}\n\n.input-field {\n  height: 100rpx;\n  background: #f5f7fa;\n  border-radius: 20rpx;\n  padding: 0 30rpx;\n  font-size: 32rpx;\n  color: #2c3e50;\n}\n\n.submit-button {\n  width: 100%;\n  height: 100rpx;\n  background: var(--theme-color);\n  border-radius: 20rpx;\n  color: #fff;\n  font-size: 32rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.submit-button:active {\n  opacity: 0.9;\n}\n.radio-group {\n  display: flex;\n  gap: 20rpx;\n  flex-wrap: wrap;\n}\n\n.radio-item {\n  padding: 20rpx 40rpx;\n  background: #f5f7fa;\n  border-radius: 20rpx;\n  font-size: 28rpx;\n  color: #2c3e50;\n}\n\n.radio-item-active {\n  background: var(--theme-color);\n  color: #fff;\n}\n</style>","import MiniProgramPage from '/Users/linsir/Experiments/uni-app/habit-ai-uniapp/habit-ai-uniapp/pages/register/register.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","wx","request"],"mappings":";;;AA6FA,MAAM,mBAAmB;AAEzB,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL;AAAA,MACA,UAAU;AAAA,QACR,WAAW;AAAA,QACX,UAAU;AAAA,QACV,QAAQ;AAAA;AAAA,MACT;AAAA,MACD,OAAO;AAAA,MACP,UAAU;AAAA,MACV,UAAU;AAAA,MACV,iBAAiB;AAAA;AAAA,MACjB,SAAS;AAAA,QACP,EAAE,OAAO,QAAQ,OAAO,SAAU;AAAA,QAClC,EAAE,OAAO,QAAQ,OAAO,SAAU;AAAA,QAClC,EAAE,OAAO,MAAM,OAAO,eAAe;AAAA,MACvC;AAAA,IACF;AAAA,EACD;AAAA,EACD,SAAS;AAAA,IACP,SAAS;AACPA,oBAAAA,MAAI,aAAa;AAAA,IAClB;AAAA,IACD,iBAAiB;AAEfC,oBAAAA,KAAG,eAAe;AAAA,QAChB,MAAM;AAAA,QACN,SAAS,CAAC,QAAQ;AAChB,eAAK,WAAW;AAAA,YACd,WAAW,IAAI,SAAS;AAAA,YACxB,UAAU,IAAI,SAAS;AAAA,UACzB;AAEAD,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,WACP;AAAA,QACF;AAAA,QACD,MAAM,CAAC,QAAQ;AACbA,wBAAAA,MAAc,MAAA,SAAA,sCAAA,aAAa,GAAG;AAC9BA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,WACP;AAAA,QACH;AAAA,OACD;AAAA,IACF;AAAA,IAED,iBAAiB,GAAG;AAClB,WAAK,SAAS,WAAW,EAAE,OAAO;AAAA,IACnC;AAAA;AAAA,IAGD,WAAW,OAAO;AAChB,WAAK,kBAAkB;AAAA,IACxB;AAAA,IAED,MAAM,iBAAiB;AACrB,UAAI,CAAC,KAAK,SAAS,WAAW;AAC5BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AACD;AAAA,MACF;AAEA,UAAI,CAAC,KAAK,SAAS,UAAU;AAC3BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AACD;AAAA,MACF;AAEA,UAAI,CAAC,KAAK,SAAS,CAAC,YAAY,KAAK,KAAK,KAAK,GAAG;AAChDA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AACD;AAAA,MACF;AAEA,UAAI,CAAC,KAAK,YAAY,KAAK,SAAS,SAAS,GAAG;AAC9CA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AACD;AAAA,MACF;AAEAA,oBAAAA,MAAI,YAAY;AAAA,QACd,OAAO;AAAA,OACR;AAED,UAAI;AACF,cAAM,eAAe;AAAA,UACnB,WAAW,KAAK,SAAS;AAAA,UACzB,UAAU,KAAK,SAAS;AAAA,UACxB,WAAW,KAAK;AAAA,UAChB,UAAU,KAAK;AAAA,UACf,eAAe,KAAK,SAAS,UAAU;AAAA,UACvC,mBAAmB,KAAK,YAAY;AAAA,UACpC,mBAAmB,KAAK;AAAA;AAAA,QAC1B;AAGA,eAAO,KAAK,YAAY,EAAE,QAAQ,SAAO;AACvC,cAAI,aAAa,GAAG,MAAM,QAAW;AACnC,mBAAO,aAAa,GAAG;AAAA,UACzB;AAAA,SACD;AAED,cAAM,MAAM,MAAME,kBAAQ;AAAA,UACxB,KAAK;AAAA,UACL,QAAQ;AAAA,UACR,MAAM;AAAA,SACP;AAGDF,sBAAAA,MAAI,eAAe,SAAS,IAAI,KAAK;AACrCA,sBAAG,MAAC,eAAe,YAAY;AAAA,UAC7B,WAAW,KAAK,SAAS;AAAA,UACzB,UAAU,KAAK,SAAS;AAAA,UACxB,OAAO,KAAK;AAAA,UACZ,QAAQ,IAAI;AAAA,UACZ,QAAQ,KAAK,SAAS;AAAA,SACvB;AAEDA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AAED,mBAAW,MAAM;AACfA,wBAAAA,MAAI,SAAS;AAAA,YACX,KAAK;AAAA,WACN;AAAA,QACF,GAAE,IAAI;AAAA,MACP,SAAO,OAAO;AACdA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO,MAAM,WAAW;AAAA,UACxB,MAAM;AAAA,SACP;AAAA,MACH,UAAU;AACRA,sBAAAA,MAAI,YAAY;AAAA,MAClB;AAAA,IACD;AAAA,IACD,MAAM,eAAe,GAAG;AACtB,YAAM,EAAE,cAAc,EAAE;AACxB,WAAK,SAAS,YAAY;AAE1B,UAAI;AAiBFA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AAAA,MACD,SAAO,OAAO;AACdA,sBAAAA,MAAA,MAAA,SAAA,sCAAc,iBAAiB,KAAK;AAEpCA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,SACP;AAAA,MACH;AAAA,IACD;AAAA,IAED,iBAAiB;AACfA,oBAAAA,MAAI,eAAe;AAAA,QACjB,MAAM;AAAA,QACN,SAAS,CAAC,QAAQ;AAChB,eAAK,SAAS,WAAW,IAAI,SAAS;AACtCA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,WACP;AAAA,QACF;AAAA,QACD,MAAM,CAAC,QAAQ;AACbA,wBAAAA,MAAc,MAAA,SAAA,sCAAA,aAAa,GAAG;AAC9BA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,WACP;AAAA,QACH;AAAA,OACD;AAAA,IACH;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzSA,GAAG,WAAW,eAAe;"}